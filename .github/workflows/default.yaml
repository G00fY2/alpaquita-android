name: "Android Image Pipeline"

on:
  push:
    branches:
      - main
    paths:
      - 'versions.env'
      - 'Dockerfile'
      - 'scripts/**'
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    name: "üõ†Ô∏è Prepare Build Matrix"
    runs-on: ubuntu-24.04
    outputs:
      jdk_versions: ${{ steps.jdk-versions-extractor.outputs.versions_json }}
      platform_versions: ${{ steps.android-platform-versions-fetcher.outputs.versions_json }}
      cmdline_tools_id: ${{ steps.cmdline-tools-id-fetcher.outputs.cmdline_tools_id }}
      platform_tools_version: ${{ env.ANDROID_PLATFORM_TOOLS_VERSION }}
      build_tools_version: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}
      sha_short: ${{ env.SHA_SHORT }}
      dry_run: ${{ steps.set-build-mode.outputs.dry_run || 'false' }}
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: "Set build mode"
        id: set-build-mode
        # TODO remove second if condition for final setup
        if: |
          github.event_name == 'pull_request' ||
          github.ref == 'refs/heads/main'
        run: echo "dry_run=true" >> "$GITHUB_OUTPUT"

      - name: "Prepare environment variables"
        run: |
          grep -v '^#' versions.env >> "$GITHUB_ENV"
          echo "SHA_SHORT=$(git rev-parse --short HEAD)" >> "$GITHUB_ENV"

      - name: "Get supported jdk versions from Dockerfile"
        id: jdk-versions-extractor
        uses: ./.github/actions/jdk-versions-extractor
        with:
          dockerfile_path: 'Dockerfile'

      - name: "Get command-line tools ID based on version"
        id: cmdline-tools-id-fetcher
        uses: ./.github/actions/cmdline-tools-id-fetcher
        with:
          version: ${{ env.ANDROID_CMDLINE_TOOLS_VERSION }}

      - name: "Get latest Android Platform versions"
        id: android-platform-versions-fetcher
        uses: ./.github/actions/android-platform-versions-fetcher
        with:
          max_version: ${{ env.ANDROID_PLATFORM_LATEST_VERSION }}

  build:
    needs: setup
    runs-on: ubuntu-24.04
    name: >
      ${{ needs.setup.outputs.dry_run == 'true' && 'üî¨ Validate' || 'üì¶ Build' }}
      (${{ matrix.jdk_version }}, Android ${{ matrix.platform_version }})
    strategy:
      matrix:
        jdk_version: ${{ fromJson(needs.setup.outputs.jdk_versions) }}
        platform_version: ${{ fromJson(needs.setup.outputs.platform_versions) }}

    env:
      DOCKER_BUILD_ARGS: |
        BASE_IMAGE=${{ matrix.jdk_version }}
        IMAGE_VERSION=0.0.1
        GIT_HASH=${{ needs.setup.outputs.sha_short }}
        ANDROID_CMDLINE_TOOLS_ID=${{ needs.setup.outputs.cmdline_tools_id }}
        ANDROID_PLATFORM_TOOLS_VERSION=${{ needs.setup.outputs.platform_tools_version }}
        ANDROID_BUILD_TOOLS_VERSION=${{ needs.setup.outputs.build_tools_version }}
        ANDROID_PLATFORM_VERSION=${{ matrix.platform_version }}

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: "Set up QEMU"
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
        env:
          DOCKER_BUILDX_VERSION: v0.31.1
          DOCKER_BUILDKIT_VERSION: v0.27.1
        with:
          version: ${{ env.DOCKER_BUILDX_VERSION }}
          driver-opts: image=moby/buildkit:${{ env.DOCKER_BUILDKIT_VERSION }}

      - name: "Build Docker Image without pushing"
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          context: .
          load: true
          platforms: linux/amd64
          tags: alpaquita-android-image:latest
          build-args: ${{ env.DOCKER_BUILD_ARGS }}

      - name: "Run Dive"
        id: dive-analyze
        uses: ./.github/actions/dive-analyze
        env:
          DIVE_VERSION: v0.13.1
        with:
          image-ref: alpaquita-android-image:latest
          dive-ci-config: .github/.dive-ci
          dive-version: ${{ env.DIVE_VERSION }}

      - name: "Run Trivy"
        uses: aquasecurity/trivy-action@e368e328979b113139d6f9068e03accaed98a518 # 0.34.1
        with:
          image-ref: alpaquita-android-image:latest
          scan-type: image
          trivy-config: .github/trivy.yaml

      - name: "Run image and generate Manifest"
        uses: ./.github/actions/generate-manifest
        with:
          image-ref: alpaquita-android-image:latest
          jdk_version: ${{ matrix.jdk_version }}
          android_api: ${{ matrix.platform_version }}

      - name: "Build and push Docker Images"
        if: ${{ needs.setup.outputs.dry_run == 'false' }}
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: alpaquita-android-image:latest
          build-args: ${{ env.DOCKER_BUILD_ARGS }}
          outputs: type=registry,compression=zstd,compression-level=9,force-compression=true

  build-summary:
    name: "üèÅ Build Matrix Complete"
    runs-on: ubuntu-24.04
    if: always()
    needs: build
    steps:
      - name: "Consolidate build status"
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            exit 1
          fi
