name: "Android Image Pipeline"

on:
  push:
    branches:
      - main

jobs:
  setup:
    name: "üõ†Ô∏è Prepare Build Matrix"
    runs-on: ubuntu-24.04
    outputs:
      jdk_versions: ${{ steps.jdk-versions-extractor.outputs.versions_json }}
      platform_versions: ${{ steps.android-platform-versions-fetcher.outputs.versions_json }}
      cmdline_tools_id: ${{ steps.cmdline-tools-id-fetcher.outputs.cmdline_tools_id }}
      platform_tools_version: ${{ env.ANDROID_PLATFORM_TOOLS_VERSION }}
      build_tools_version: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}
      sha_short: ${{ env.SHA_SHORT }}
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v6

      - name: "Prepare environment variables"
        run: |
          grep -v '^#' versions.env >> "$GITHUB_ENV"
          echo "SHA_SHORT=$(git rev-parse --short HEAD)" >> "$GITHUB_ENV"

      - name: "Get supported jdk versions from Dockerfile"
        id: jdk-versions-extractor
        uses: ./.github/actions/jdk-versions-extractor
        with:
          dockerfile_path: 'Dockerfile'

      - name: "Get command-line tools ID based on version"
        id: cmdline-tools-id-fetcher
        uses: ./.github/actions/cmdline-tools-id-fetcher
        with:
          version: ${{ env.ANDROID_CMDLINE_TOOLS_VERSION }}

      - name: "Get latest Android Platform versions"
        id: android-platform-versions-fetcher
        uses: ./.github/actions/android-platform-versions-fetcher
        with:
          max_version: ${{ env.ANDROID_PLATFORM_LATEST_VERSION }}

  build:
    needs: setup
    runs-on: ubuntu-24.04
    name: "üì¶ Build (${{ matrix.jdk_version }}, Android ${{ matrix.platform_version }})"
    strategy:
      matrix:
        jdk_version: ${{ fromJson(needs.setup.outputs.jdk_versions) }}
        platform_version: ${{ fromJson(needs.setup.outputs.platform_versions) }}

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v6

      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "Build Docker Image"
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: alpaquita-android-image:latest
          build-args: |
            BASE_IMAGE=${{ matrix.jdk_version }}
            IMAGE_VERSION=0.0.1
            GIT_HASH=${{ needs.setup.outputs.sha_short }}
            ANDROID_CMDLINE_TOOLS_ID=${{ needs.setup.outputs.cmdline_tools_id }}
            ANDROID_PLATFORM_TOOLS_VERSION=${{ needs.setup.outputs.platform_tools_version }}
            ANDROID_BUILD_TOOLS_VERSION=${{ needs.setup.outputs.build_tools_version }}
            ANDROID_PLATFORM_VERSION=${{ matrix.platform_version }}
          outputs: |
            type=docker,dest=image.tar,compression=zstd,compression-level=3,force-compression=true

  build-summary:
    name: "üèÅ Build Matrix Complete"
    runs-on: ubuntu-24.04
    if: always()
    needs: build
    steps:
      - name: "Consolidate build status"
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            exit 1
          fi
